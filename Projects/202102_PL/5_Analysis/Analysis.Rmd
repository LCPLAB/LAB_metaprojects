---
title: "Analysis ~ Replication study of Kerwer et al.(2020)"
author: "LCP lab"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
    code_folding: hide
    self_contained: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(tidyverse)

library(lubridate)
library(effectsize)
```


## 匯入及預覽資料欄位資訊

```{r rawdata, echo=TRUE}
## locate the rawdata file
zip_path <- list.files(path = "..",pattern = "jatos_results.zip",include.dirs = TRUE,recursive = TRUE,full.names = TRUE)
## import raw data
df <- read_csv(unz(zip_path, filename = "rawdata.csv"))
```


整合有效參與者的原始回應資料檔"rawdata.csv"，存放路徑是`r zip_path`。資料欄位共有`r dim(df)[2]`項，來自`r length(unique(df$jatosStudyResultId))`位參與者，`r dim(df)[1]`筆回應資料。

資料編碼薄以[codebook套件](codebook.Rmd)製作，製作完成存放路徑與本文件相同。

- 依分析目的分割資料集合

```{r data-split}
## Extract the system variables
df_sys <- df %>% select(starts_with(c("identifier","jatos","browser_","count_","date_","experiment_","screen_","system_","Start ","Last ","Duration","Batch","Worker ","State","Message")))

## Reserve the analytical variables in rawdata df
df <- df %>% select(!names(df_sys)[-c(1,2)])

## Split basic data
df_Basic <- filter(df, Q_type == "Basic")

## Exclude the variables full of "None"
df_Basic <- df_Basic[,c(which(colSums(df_Basic!="None") == dim(df_Basic)[1]),which(is.na(colSums(df_Basic!="None") == dim(df_Basic)[1])) # Get "response"
)]

## Split Belief data
df_Belief <- filter(df, Q_type == "Belief")
## Exclude the variables full of "None"
df_Belief <- df_Belief[,which(colSums(df_Belief!="None") == dim(df_Belief)[1])]


## Split self evaluation data
df_self_eval <- filter(df, Q_type == "self_eval")
## Exclude the variables full of "None"
df_self_eval <- df_self_eval[,which(colSums(df_self_eval!="None") == dim(df_self_eval)[1])]

## Split post reading Question data
df_Post <- dplyr::filter(df, Q_type == "Post_survey")
## Exclude the variables full of "None"
df_Post <- df_Post[,which(colSums(df_Post!="None") == dim(df_Post)[1])]

## Split knowledge data
df_knowledge <- filter(df, Q_type == "Knowledge")
## Exclude the variables full of "None"
df_knowledge <- df_knowledge[,which(colSums(df_knowledge!="None") == dim(df_knowledge)[1])]

## Split Exit
df_Exit <- filter(df, Q_type == "Exit")
## Exclude the variables full of "None"
df_Exit <- df_Exit[,c(which(colSums(df_Exit!="None") == dim(df_Exit)[1]),which(is.na(colSums(df_Exit!="None") == dim(df_Exit)[1]))) ]
```



## 參與者基本資訊統計


- 作答時間分佈


```{r duration}
## Convert duration to minutes
minutes_count <- ((df_sys$Duration %>% hms() %>% hour()*60)+
(df_sys$Duration %>% hms() %>% minute())) 

## Summary of study duration by minutes 
minutes_count %>% summary()

## draw a box plot
minutes_count%>%
  log10() %>% ## convert minutes to log10
  boxplot(ylab="log10(minutes)")
```



### 作答時間與理解正確率散佈趨勢

```{r duration-post-analysis, echo=TRUE, message=FALSE, warning=FALSE}
## Convert duration to minutes
df_post_trend <- df_sys %>% distinct() %>%
  select(jatosStudyResultId, Duration) %>%
  mutate(minutes_count = 
                    (Duration %>% hms() %>% hour())*60 +
                    Duration %>% hms() %>% minute() ) %>%
  left_join( (df_knowledge %>% 
  filter(Q_presented == 1) %>%   ## 過濾未出現的題目
  mutate(response = ifelse(response == "是","y","n")) %>%       #轉換參與者回答"是"換成"y"
  mutate(score = ifelse(response == correct_response,1,0)) %>%  #檢測如果回答等於正確答案得1分
  group_by(jatosStudyResultId) %>%                               #以個人分組
  summarise(Correct_rate = mean(score))),    #計算正確率
by="jatosStudyResultId")

ggplot(df_post_trend,aes(x=Correct_rate, y=minutes_count))+
   geom_point()
```

```{r strange-participants}
strange_id <- df_post_trend %>%
  filter(!(Correct_rate >0.5) | minutes_count > 200 ) %>%
  pull(jatosStudyResultId)
```


共有`r length(strange_id)`參與者理解題正確率未超過50%或作答時間超過200分鐘。排除後，採用`r length(unique(df_sys$jatosStudyResultId)) - length(strange_id)`
參與者資料進行以下資料處理及統計分析。

**參與者性別人數**

```{r basic-gender}
df_Basic %>% filter(Topic=="gender" & !(jatosStudyResultId %in% strange_id)) %>%
  ggplot(aes(x = response, fill = response)) +
  geom_bar(show.legend = FALSE) +
  scale_x_discrete(name = "參與者性別") +
  scale_y_continuous(name = "參與者人數") +
  theme_minimal() +
  scale_fill_viridis_d(option = "E")
```

**參與者年齡分佈**

```{r basic-birth}
## Confirm the median and MAD
response_b <- df_Basic %>% filter(Topic=="birth" & !(jatosStudyResultId %in% strange_id)) %>%
  summarise(M = median(as.numeric(response),na.rm = TRUE), 
            dev= mad(as.numeric(response),na.rm = TRUE),
            min(as.numeric(response),na.rm = TRUE),
            max(as.numeric(response),na.rm = TRUE))
## median = 2, MAD = 1.48; median +/- 66 MAD are acceptable responses.

df_Basic %>% filter(Topic=="birth" & !(jatosStudyResultId %in% strange_id)) %>%
  mutate(last_two = ifelse(as.numeric(response)< response_b$M + 66*response_b$dev,as.numeric(response),NA), ## Turn strange response to missing value NA
         age = ifelse(!is.na(last_two),ifelse(last_two>50,2022-(1900+last_two),2022-(2000+last_two) ),NA )) %>% ## Estimate participant's age
#df_Basic %>% filter(Topic=="birth") %>%
  ggplot(aes(x = as.character(age), fill = as.character(age))) +
  geom_bar(show.legend = FALSE) +
  scale_x_discrete(name = "參與者年齡") +
  scale_y_continuous(name = "參與者人數") +
  theme_minimal() +
  scale_fill_viridis_d(option = "E")
```

## 問卷反應項目描述統計

> 依問題型態摘要

- 知識信念(belief)
(采妤)

```{r belief}
df_Belief$response <- sapply(
 strsplit(
 gsub(df_Belief$response,pattern = " ",replacement = ""),
 split = "："
 ),
 "[[",
 1
 )

tb_Belief <- df_Belief %>% #filter(response %>%
#  summarise("6：完全正確" = mean(rating == 6),
#"5：大部份正確" = mean(rating == 5),
#"4：有點正確" = mean(rating == 4),
#"3：不太可能是正確的" = mean(rating == 3),
#"2：大部份不正確" = mean(rating == 2),
#"1：完全不正確" = mean(rating == 1))) %>%
filter(!(jatosStudyResultId %in% strange_id)) %>%
  group_by(Q_type,Topic, jatosStudyResultId) %>%
         summarise(score = mean(as.numeric(response),na.rm = TRUE)
            ) %>%
        group_by(Q_type,Topic) %>%
         summarise(N = n(),
                   M = mean(score),
                   SD = sd(score))

#  ggplot(df_Belief, aes(Question, response, fill=Q)) +
#  stat_summary(fun = mean, geom = "col", alpha = 0.5) +
#  stat_summary(fun.data = mean_se, geom = "errorbar",
#               width = 0.25) +
#  coord_cartesian(ylim = c(1, 5))
```

`r knitr::kable(tb_Belief)`

- 科學活動經驗(self eval)
(明翰)


- 讀後調查(Post Survey)
(祥偉)

```{r post-study, echo=TRUE, results='show', message=TRUE, warning=TRUE, include=T}
df_Post$response <- sapply(
 strsplit(
 gsub(df_Post$response,pattern = " ",replacement = ""),
 split = ":"
 ),
 "[[",
 1
 )

#new_post <- filter(.data = df_Post,Topic %in% c("Comprehensibility","Scientificness","Credibility","Veracity","Decision") & !(jatosStudyResultId %in% strange_id)) %>% 
##抓出要分析的TOPIC

  
#mutate(summary = ifelse(NH == "N" & OSA == "Y", "OSA",ifelse(NH == "N" & OSA == "N", "PLS","NH_PLS"))) 
#將摘要分類為PLS、OSA、NH_PLS


#new_post$response <- gsub("8: 完全讀得懂", 8, new_post$response)


#new_post$response <- gsub("8: 非常有科學性", 8, new_post$response)
#new_post$response <- gsub("8: 非常可信", 8, new_post$response)
#new_post$response <- gsub("8: 我認為一定可以", 8, new_post$response)
#new_post$response <- gsub("1: 完全不可信", 1, new_post$response)
#new_post$response <- gsub("1: 完全沒有科學性", 1, new_post$response)
#new_post$response <- gsub("1: 完全讀不懂", 1, new_post$response)
#new_post$response <- gsub("1: 我認為完全不可以", 1, new_post$response) 

##將包含中文的response替換數字

tb_Post <- df_Post %>% filter(Topic %in% c("Comprehensibility","Scientificness","Credibility","Veracity","Decision") & !(jatosStudyResultId %in% strange_id)) %>%
mutate(summary = ifelse(NH == "N" & OSA == "Y", "OSA",ifelse(NH == "N" & OSA == "N", "PLS","NH_PLS"))) %>%
#table3_cells <- new_post %>%
#        filter(summary == "PLS")   %>%
        group_by(jatosStudyResultId,Topic,summary) %>%
        summarise(post_score = mean(as.numeric(response),na.rm = TRUE)) %>%
  group_by(Topic, summary) %>%
         summarise(N = n(),
                   M = mean(post_score,na.rm = TRUE),
                   SD = sd(post_score,na.rm = TRUE)
            ) 

```     

`r knitr::kable(tb_Post)`


- 閱讀理解(Knowledge)
(子渝)

```{r Knowledge}
P_accuracy <- df_knowledge %>% 
  filter(Q_presented == 1 & !(jatosStudyResultId %in% strange_id)) %>%   ## 過濾未出現的題目
  mutate(article_type = ifelse(NH == "N" & OSA == "Y", "OSA",ifelse(NH == "N" & OSA == "N", "PLS","NH_PLS"))) %>%                                                             #將摘要分類為PLS、OSA、NH_PLS
  mutate(response = ifelse(response == "是","y","n")) %>%       #轉換參與者回答"是"換成"y"
  mutate(score = ifelse(response == correct_response,1,0)) %>%    #檢測如果回答等於正確答案得1分
  group_by(jatosStudyResultId, article_type) %>%                                         #以個別參與者及摘要分組
  summarise(p_accuracy = sum(score)/length(score)
              ) #%>%

tb_knowledge1 <- P_accuracy %>%
  group_by(article_type) %>%                                         #以摘要分組
  summarise(N = n(), M = mean(p_accuracy,na.rm=TRUE), SD = sd(p_accuracy,na.rm=TRUE)#sum(score)/n()
              )                      #計算正確率


## Retrieve the participants had all types of questions
full_id <- P_accuracy %>% count(jatosStudyResultId) %>%
  filter(n==3) %>% pull(jatosStudyResultId)
tb_knowledge2 <- P_accuracy %>%
  filter(jatosStudyResultId %in% full_id) %>%
  group_by(article_type) %>%                                         #以摘要分組
  summarise(N = n(), M = mean(p_accuracy,na.rm=TRUE), SD = sd(p_accuracy,na.rm=TRUE)#sum(score)/n()
              )                      #計算正確率

## 資料整理
knowledge <- df_knowledge %>% 
  filter(Q_presented == 1 & !(jatosStudyResultId %in% strange_id)) %>%   ## 過濾未出現的題目
  mutate(summary = ifelse(NH == "N" & OSA == "Y", "OSA",ifelse(NH == "N" & OSA == "N", "PLS","NH_PLS"))) %>%                                                             #將摘要分類為PLS、OSA、NH_PLS
  mutate(response = ifelse(response == "是","y","n")) %>%       #轉換參與者回答"是"換成"y"
  mutate(score = ifelse(response == correct_response,1,0))      #檢測如果回答等於正確答案得1分

## 總正確數
table(knowledge$score)

## 總正確率
table(knowledge$score)/sum(table(knowledge$score))

## 各類摘要錯誤率
table(knowledge$score, knowledge$summary)[1,]/colSums(table(knowledge$score, knowledge$summary))

print("各類摘要正確率")
table(knowledge$score, knowledge$summary)[2,]/colSums(table(knowledge$score, knowledge$summary))
```

三種文本閱讀正確率平均值及標準差

納入所有非極端值的參與者 
`r knitr::kable(tb_knowledge1)`


排除理解題目不完整的參與者
`r knitr::kable(tb_knowledge2)`

- 出口回饋(Exit)


## 預先註冊分析項目

